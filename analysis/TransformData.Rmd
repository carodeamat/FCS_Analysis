---
title: "Pre-processing of FCS files: Arcsih Transformation"
author: "Carolina"
date: "2024-12-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is an R Markdown document to pre-process FCS files by applying transformation to parameter values. 

##Load packages and utilities
```{r, warning=FALSE}

library(tidyverse)
library(flowCore)
library(flowVS)

source("../src/Preprocessing_Functions.R")

```

##Paths to directories and files
*fcsdir* is the path to the directory containing the FCS files. \
*metafile* is the path to the metadata file, which is a csv file containing the sample name (same name as fcs file) in the first column, as well as all the information for each sample (e.g. mouseID, Treatment, Sex, Tissue, etc.). \
*outdir* is the path to the output directory that will contain the output data after transformation. The directory will be created if it doesn't exist.

```{r}
# Set directories
fcsdir <- "../data/FCS/"
metafile <- "../data/metadata.csv"
outdir <- "../data/TransformedData/"

```

## Read data
The `read.fcs` function reads the metadata and identify the fcs files in the fcs directory to read them and create a flowset object. It will also print the fcs file names that are included in the flowset, and will inform of any excluded (present in fcsdir but not in metadata), or missing (in metadata, but not found in fcsdir) fcs file.

```{r}

metadata <- read.csv(metafile)

fset <- read.fcs(fcs.dir.path=fcsdir,
                 metadata=metadata,
                 transform=FALSE,
                 downsample=5000,
                 truncate.max=FALSE)

```

## Obatin parameters to transform
Copy and paste a representative sample from the list above to the variable "representative_sample". \
The following code will create a data frame from the representative sample containing the channels, labels, markers, and an initial cofactor value for transformation. \
Then, it will print a list of the available markers and assigned cofactor, which can be copied and paste to the next section to adjust the cofactor values.

```{r}
# Set the variables. Rerun as needed.
representative_sample <- "<Sample_001.fcs>"
Label_separator <- NULL
initial_cofactor <- 200

###################################################################

# Data frame containing the channels and respective marker names
fftest <- fset@frames[[representative_sample]]

param.df <- process.param (fftest,
                           cofactor=initial_cofactor,
                           label.sep=Label_separator)

```

##Test cofactors
Flow data requires transformation (e.g. log, biexponential,etc). Hyperbolic arcsine (arcsinh) transformation is recommended in this case and it is calculated based on a determined cofactor. \
In the following code the cofactor for each marker can be adjusted then a transformation will be performed. \
Density plots will be printed for each marker. \
The cofactors can be re-adjusted and the code re-run as needed. \
If needed, another representative sample can be tested by editing the previous section.
```{r}

# Adjust cofactors and re-run as needed
custom.cof <- c(
#copy markers and cofactors here as:
'param1'=1000,
'param2'=1000,
#etc.
)

##############################################################################

# Replace the cofactors
param.df$cofactor[match(names(custom.cof), param.df$marker)] = custom.cof


fftestset <- as(fftest,"flowSet")

# Transform the representative file
fftest.transf <- transFlowVS(fftestset, 
                             channels=as.character(param.df$channel), 
                             cofactor=param.df$cofactor)

fftest.transf@frames$V1@parameters@data$name[match(param.df$channel, 
                                                   fftest.transf@frames$V1@parameters@data$name)] = param.df$marker

flowViz.par.set(theme =  trellis.par.get(), reset = TRUE)

# Plot histograms for each marker to test cofactor values
densityplot(~., fftest.transf, channel = param.df$channel)



```

##Transform the flowset
After choosing the cofactors, the transformation can applied to the entire dataset with the following code.
```{r}

# Transform all the flowset with the redefined cofactors.
fst <- transFlowVS(fset, channels=as.character(param.df$channel), cofactor=param.df$cofactor)

# Get the expression matrix and respective sample
mat <- as.data.frame(exprs(as(fst,'flowFrame')),stringsAsFactors=FALSE)
mat <- mat %>% select(Original, everything())
mat$Original <- metadata[mat$Original,1]
colnames(mat)[colnames(mat)=="Original"] <- "Sample_ID"
colnames(mat)[match(param.df$channel, colnames(mat))] = param.df$marker
colnames(mat)[colnames(mat)==AutoF_channel] <- "AutoF"
glimpse(mat)

```

##Save transformed data
The output files will be saved in the pre-established output directory: \
- A csv file with the transformed expression values for the entire dataset. \
- FCS files with the transformed values.
```{r}

# Create directory if it does not exist
if (!file.exists(outdir)){
    dir.create(outdir)
}

# Save flowframes wihtin flowset as fcs files using the flowCore package
write.flowSet(fst, outdir=outdir, filename = sampleNames(fst))

# Save the transformed expression matrix
write.csv(mat, file.path(outdir, "TransfExprData.csv"), row.names=FALSE)

```

