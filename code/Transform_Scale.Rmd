---
title: "Pre-processing of FCS files: Arcsih Transformation"
author: "Carolina"
date: "2024-12-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Transformation

This is an R Markdown document to pre-process FCS files by applying transformation to parameter values. 

## Load packages and utilities
```{r}

library(tidyverse)
library(flowCore)
library(flowVS)

source("Preprocessing_Functions.R")

```

## Directories
The input directory (indir) is were all the data is store (fcs files/directory and metadata file)
The fcs directory (fcsdir) is where the FCS files are located.
The output directory (outdir) will contain the results of the analysis
The plotd directory (plotdir) will contain all the output images generated.


```{r}
# Set directories

indir <- "../data/"
fcsdir <- "../data/FCS/"

```

## Read data

A csv file named "metadata.csv", containing the sample name (same as fcs file) as well as all the information for each files (e.g. mouseID, Treatment, Sex, Tissue, etc.) must be located in the working directory (root.dir).
The read.fcs function reads the metadata and identify the fcs files in the fcs directory to read them and create a flowset object. It will also print the fcs file names that are included in the flowset, and will inform of any excluded (present in fcsdir but not in metadata), or missing (in metadata, but not found in fcsdir) fcs file.

```{r}

metadata <- read.csv(file.path(indir, "metadata.csv"))

fset <- read.fcs(fcs.dir.path=fcsdir,
                 metadata=metadata,
                 transform=FALSE,
                 downsample=NULL,
                 truncate.max=FALSE)

```

## Obatin parameters to transform

```{r}

representative_sample <- "NKT002_F.fcs"

# Data frame containing the channels and respective marker names
fftest <- fset@frames[[representative_sample]]
param.df <- data.frame(channel = fftest@parameters@data$name, 
                       label = fftest@parameters@data$desc)

# See the label format
glimpse(param.df)

```


```{r}

AutoF_channel <- "FJComp-UV446-A"
Label_separator <- "-"  

# Filter the parameters to get only Area measures of markers, retrieve marker names, and set initial cofactor value.
param.df <- process.param (param.df,
                           AutoF.ch=AutoF_channel,
                           marker.color=TRUE,
                           label.sep=Label_separator,
                           cofactor=1000)


```


```{r}

# Adjust and re-run as needed
custom.cof <- c(
'FceR1g'=1000, 
'CD56'=700, 
'CD94'=1000, 
'CD45'=1000, 
'GNLY'=1000, 
'CD39'=1000, 
'L_D'=2000, 
'CD3'=1000, 
'CD4'=1000, 
'TCRgd'=2000, 
'CXCR6'=1000, 
'CD62L'=1000, 
'TCRVa72'=3000, 
'CD8'=2000, 
'CD1dTet'=1000, 
'GzmB'=1000, 
'CD319'=1000, 
'CD57'=1000, 
'CD161'=1000, 
'PD1'=1500, 
'CD14_19'=3000, 
'CD16'=1000, 
'MR1Tet'=1000, 
'RORgt'=1000, 
'2B4'=1000, 
'Tbet'=1000)


# Replace the cofactors
param.df$cofactor[match(names(custom.cof), param.df$marker)] = custom.cof


fftestset <- as(fftest,"flowSet")

# Transform the representative file
fftest.transf <- transFlowVS(fftestset, 
                             channels=as.character(param.df$channel), 
                             cofactor=param.df$cofactor)

fftest.transf@frames$V1@parameters@data$name[match(param.df$channel, 
                                                   fftest.transf@frames$V1@parameters@data$name)] = param.df$marker

flowViz.par.set(theme =  trellis.par.get(), reset = TRUE)

# Plot histograms for each marker to test cofactor values
densityplot(~., fftest.transf, channel = param.df$channel)



```


```{r}

# Transform all the flowset with the redefined cofactors
fst <- transFlowVS(fset, channels=as.character(param.df$channel), cofactor=param.df$cofactor)

# Get the expression matrix and respective sample
mat <- as.data.frame(exprs(as(fst,'flowFrame')),stringsAsFactors=FALSE)
mat <- mat %>% select(Original, everything())
mat$Original <- metadata[mat$Original,1]
colnames(mat)[colnames(mat)=="Original"] <- "Sample_ID"
colnames(mat)[match(param.df$channel, colnames(mat))] = param.df$marker
glimpse(mat)

```

```{r}

# Create directory if it does not exist
if (!file.exists(file.path(indir, "Transformed_Data"))){
    dir.create(file.path(indir, "Transformed_Data"))
}

tranf_data_dir <- file.path(indir, "Transformed_Data")

# Save flowframes wihtin flowset as fcs files using the flowCore package
write.flowSet(fst, outdir=tranf_data_dir, filename = sampleNames(fst))

# Save the transformed expression matrix
write.csv(mat, file.path(tranf_data_dir, "TransfExprData.csv"))

```

